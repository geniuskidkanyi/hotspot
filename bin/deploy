#!/bin/bash
set -e

echo "🚀 Deploying Hotspot to production..."

# Server details
SERVER_USER="deploy"
SERVER_HOST="65.21.247.104"
DEPLOY_PATH="/home/deploy/hotspot"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}📦 Building Docker image locally...${NC}"
docker compose build

echo -e "${BLUE}🏷️  Tagging image...${NC}"
GIT_SHA=$(git rev-parse --short HEAD)
docker tag geniuskidkanyi/hotspot:latest geniuskidkanyi/hotspot:$GIT_SHA
docker tag geniuskidkanyi/hotspot:latest geniuskidkanyi/hotspot:latest

echo -e "${BLUE}📤 Pushing to Docker Hub...${NC}"
docker push geniuskidkanyi/hotspot:latest
docker push geniuskidkanyi/hotspot:$GIT_SHA

echo -e "${BLUE}🔄 Deploying to server (65.21.247.104)...${NC}"
ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
cd /home/deploy/hotspot

# Pull latest code
echo "📥 Pulling latest code..."
git pull origin main

# Pull latest images
echo "🐳 Pulling Docker images..."
docker compose pull

# Stop old containers gracefully
echo "🛑 Stopping old containers..."
docker compose down

# Start new containers
echo "▶️  Starting new containers..."
docker compose up -d

# Wait for app to be ready
echo "⏳ Waiting for application to start..."
sleep 15

# Run migrations for all databases
echo "🗄️  Running database migrations..."
docker compose exec -T web bin/rails db:migrate:all

# Check health
echo "🏥 Checking application health..."
sleep 5
if curl -f http://localhost:3000/up; then
    echo "✅ Health check passed!"
else
    echo "⚠️  Health check failed - checking logs..."
    docker compose logs --tail=50 web
fi

echo "✅ Deployment complete!"
ENDSSH

if [ $? -eq 0 ]; then
    echo -e "${GREEN}✅ Deployment successful!${NC}"
    echo -e "${GREEN}🌐 Application available at: https://app.root.gm${NC}"
    echo -e "${BLUE}📊 Git SHA: $GIT_SHA${NC}"
else
    echo -e "${RED}❌ Deployment failed!${NC}"
    exit 1
fi
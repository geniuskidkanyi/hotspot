#!/bin/bash
set -e

echo "ğŸš€ Deploying Hotspot to production..."

# Server details
SERVER_USER="deploy"
SERVER_HOST="65.21.247.104"
DEPLOY_PATH="/home/deploy/hotspot"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ“¦ Building Docker image locally...${NC}"
docker compose build

echo -e "${BLUE}ğŸ·ï¸  Tagging image...${NC}"
GIT_SHA=$(git rev-parse --short HEAD)
docker tag geniuskidkanyi/hotspot:latest geniuskidkanyi/hotspot:$GIT_SHA
docker tag geniuskidkanyi/hotspot:latest geniuskidkanyi/hotspot:latest

echo -e "${BLUE}ğŸ“¤ Pushing to Docker Hub...${NC}"
docker push geniuskidkanyi/hotspot:latest
docker push geniuskidkanyi/hotspot:$GIT_SHA

echo -e "${BLUE}ğŸ”„ Deploying to server (65.21.247.104)...${NC}"
ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
cd /home/deploy/hotspot

# Pull latest code
echo "ğŸ“¥ Pulling latest code..."
git pull origin main

# Pull latest images
echo "ğŸ³ Pulling Docker images..."
docker compose pull

# Stop old containers gracefully
echo "ğŸ›‘ Stopping old containers..."
docker compose down

# Start new containers
echo "â–¶ï¸  Starting new containers..."
docker compose up -d

# Wait for app to be ready
echo "â³ Waiting for application to start..."
sleep 15

# Run migrations for all databases
echo "ğŸ—„ï¸  Running database migrations..."
docker compose exec -T web bin/rails db:migrate:all

# Check health
echo "ğŸ¥ Checking application health..."
sleep 5
if curl -f http://localhost:3000/up; then
    echo "âœ… Health check passed!"
else
    echo "âš ï¸  Health check failed - checking logs..."
    docker compose logs --tail=50 web
fi

echo "âœ… Deployment complete!"
ENDSSH

if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ… Deployment successful!${NC}"
    echo -e "${GREEN}ğŸŒ Application available at: https://app.root.gm${NC}"
    echo -e "${BLUE}ğŸ“Š Git SHA: $GIT_SHA${NC}"
else
    echo -e "${RED}âŒ Deployment failed!${NC}"
    exit 1
fi